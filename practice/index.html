<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Cellink 实践 | Cellink 用户手册</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="/cellink-docs/imgs/icon.png">
    <meta name="description" content="一款可视化代码流程管理框架">
    <meta property="article:modified_time" content="null">
    <meta property="og:site_name" content="Cellink">
    <meta property="og:title" content="Cellink 实践">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://fluid-dev.github.io//practice/">
    <meta name="twitter:title" content="Cellink 实践">
    <meta name="twitter:url" content="https://fluid-dev.github.io//practice/">
    <meta name="twitter:card" content="/favicon.png">
    <meta name="keywords" content="cellink,可视化,流程管理,cellink文档,用户文档">
    
    <link rel="preload" href="/cellink-docs/assets/css/0.styles.88c99a0c.css" as="style"><link rel="preload" href="/cellink-docs/assets/js/app.3da618ae.js" as="script"><link rel="preload" href="/cellink-docs/assets/js/2.79f3453a.js" as="script"><link rel="preload" href="/cellink-docs/assets/js/10.f15f1fa1.js" as="script"><link rel="prefetch" href="/cellink-docs/assets/js/11.ed24114d.js"><link rel="prefetch" href="/cellink-docs/assets/js/3.43512d44.js"><link rel="prefetch" href="/cellink-docs/assets/js/4.96039860.js"><link rel="prefetch" href="/cellink-docs/assets/js/5.74f82d90.js"><link rel="prefetch" href="/cellink-docs/assets/js/6.6ead7621.js"><link rel="prefetch" href="/cellink-docs/assets/js/7.cf9d6ec2.js"><link rel="prefetch" href="/cellink-docs/assets/js/8.252b2202.js"><link rel="prefetch" href="/cellink-docs/assets/js/9.fc08a446.js">
    <link rel="stylesheet" href="/cellink-docs/assets/css/0.styles.88c99a0c.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/cellink-docs/" class="home-link router-link-active"><!----> <span class="site-name">Cellink 用户手册</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/cellink-docs/start/" class="nav-link">
  开始使用
</a></div><div class="nav-item"><a href="/cellink-docs/guide/" class="nav-link">
  配置指南
</a></div><div class="nav-item"><a href="/cellink-docs/advance/" class="nav-link">
  进阶用法
</a></div><div class="nav-item"><a href="/cellink-docs/practice/" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  Cellink 实践
</a></div><div class="nav-item"><a href="https://github.com/viibridges/cellink" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/cellink-docs/start/" class="nav-link">
  开始使用
</a></div><div class="nav-item"><a href="/cellink-docs/guide/" class="nav-link">
  配置指南
</a></div><div class="nav-item"><a href="/cellink-docs/advance/" class="nav-link">
  进阶用法
</a></div><div class="nav-item"><a href="/cellink-docs/practice/" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  Cellink 实践
</a></div><div class="nav-item"><a href="https://github.com/viibridges/cellink" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Cellink 实践</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/cellink-docs/practice/#cellink-实践" class="sidebar-link">Cellink 实践</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/cellink-docs/practice/#实践一-用不同的图实例处理不同的数据" class="sidebar-link">实践一：用不同的图实例处理不同的数据</a></li><li class="sidebar-sub-header"><a href="/cellink-docs/practice/#实践二-大胆托管你的实验代码" class="sidebar-link">实践二：大胆托管你的实验代码</a></li><li class="sidebar-sub-header"><a href="/cellink-docs/practice/#实践三-重视中间结果的展示" class="sidebar-link">实践三：重视中间结果的展示</a></li><li class="sidebar-sub-header"><a href="/cellink-docs/practice/#实践四-运用-flag-节点" class="sidebar-link">实践四：运用 Flag 节点</a></li><li class="sidebar-sub-header"><a href="/cellink-docs/practice/#实践五-worker-节点与-neck-节点" class="sidebar-link">实践五：Worker 节点与 Neck 节点</a></li><li class="sidebar-sub-header"><a href="/cellink-docs/practice/#实践六-在节点中使用-cellink" class="sidebar-link">实践六：在节点中使用 Cellink</a></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="cellink-实践"><a href="#cellink-实践" class="header-anchor">#</a> Cellink 实践</h2> <p>本小节介绍几个 Cellink 的编程实践。有些是有意设计的功能，有些是在使用过程中意外发现的特性。</p> <p>“噢，原来我们可以如此这般 ......”，Cellink 有时会带给创造者惊喜。</p> <p>我们也希望后来人能挖掘出更多奇妙。</p> <h3 id="实践一-用不同的图实例处理不同的数据"><a href="#实践一-用不同的图实例处理不同的数据" class="header-anchor">#</a> 实践一：用不同的图实例处理不同的数据</h3> <p>当一个节点被实例化时，它所在图中的所有其它节点都会被实例化。</p> <p>实例化节点并不会执行业务逻辑，所以哪怕图中有上万个节点，实例化的计算开销也不足一提（相比真正的业务需求）。</p> <p>前面提到，forward 方法在整个节点的生命周期中只会执行一次，因此节点的输出是固定的。如果要处理不同数据（比如另一张图片），我们建议实例化新的图来处理：</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token comment"># 实例化一个图，处理第一个数据</span>
rgb1 <span class="token operator">=</span> RGB<span class="token punctuation">.</span>from_image_path<span class="token punctuation">(</span><span class="token string">'IMAGE1.JPG'</span><span class="token punctuation">)</span>
diff1 <span class="token operator">=</span> rgb1<span class="token punctuation">.</span>seek<span class="token punctuation">(</span><span class="token string">'diff'</span><span class="token punctuation">)</span>

<span class="token comment"># 实例化新图，处理第二个数据</span>
rgb2 <span class="token operator">=</span> RGB<span class="token punctuation">.</span>from_image_path<span class="token punctuation">(</span><span class="token string">'IMAGE2.JPG'</span><span class="token punctuation">)</span>
diff2 <span class="token operator">=</span> rgb2<span class="token punctuation">.</span>seek<span class="token punctuation">(</span><span class="token string">'diff'</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="实践二-大胆托管你的实验代码"><a href="#实践二-大胆托管你的实验代码" class="header-anchor">#</a> 实践二：大胆托管你的实验代码</h3> <p>和业务无关的代码亦可放入图中作为节点托管（比如项目开发过程中的实验代码）。得益于 Cellink 对业务流的控制，这些非业务节点在正式的工作流程中永远不会执行。</p> <p>当然如果你介意流程视图变得杂乱，可以选择定期清理一些非业务节点（注释掉它们的 @hook_parent 装饰器即可）。</p> <h3 id="实践三-重视中间结果的展示"><a href="#实践三-重视中间结果的展示" class="header-anchor">#</a> 实践三：重视中间结果的展示</h3> <p>直观的数据可视化对梳理业务逻辑很有帮助。可以为重要的节点实现 dump 或 show 方法，用于打印或可视化节点数据。甚至创建新的可视化节点来展示它们的内容。正如上面提到的那样，不要因此而担心影响运行速度（因为那不会发生）。</p> <h3 id="实践四-运用-flag-节点"><a href="#实践四-运用-flag-节点" class="header-anchor">#</a> 实践四：运用 Flag 节点</h3> <p>我们有时候会创建一些 Flag 节点来充当控制业务流的条件。比如某节点必须满足条件 A（比如说某个节点的变量大于 0 ）才能运行，那条件 A 就可以抽象成一个 Flag 节点：</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token decorator annotation punctuation">@hook_parent</span><span class="token punctuation">(</span>Number<span class="token punctuation">)</span>
<span class="token keyword">class</span> <span class="token class-name">FlagA</span><span class="token punctuation">(</span>NodeSI<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token comment"># 由条件 A 抽象出的节点</span>
    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>parent<span class="token punctuation">.</span>val <span class="token operator">&gt;=</span> <span class="token number">0</span>
    
<span class="token decorator annotation punctuation">@hook_parent</span><span class="token punctuation">(</span>Number<span class="token punctuation">,</span> FlagA<span class="token punctuation">)</span>
<span class="token keyword">class</span> <span class="token class-name">Sqrt</span><span class="token punctuation">(</span>NodeMI<span class="token punctuation">)</span><span class="token punctuation">:</span>
	<span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        val <span class="token operator">=</span> self<span class="token punctuation">.</span>parent_list<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>val
        self<span class="token punctuation">.</span>val <span class="token operator">=</span> np<span class="token punctuation">.</span>sqrt<span class="token punctuation">(</span>val<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token boolean">True</span>
</code></pre></div><p>上面代码中，Sqrt 节点并没有访问 FlagA 的内容，而是利用 Cellink 的正向传播特性，把条件 A 变成自己运行的必要条件。</p> <p>通常来说，条件 A 对业务很重要时我们才会把它抽象成 Flag 节点。这样做有利于业务逻辑的可视化（在流程视图上能直观反映）。</p> <p>巧妙运用 NodeCI 节点还能实现其它基本逻辑（比如“异或”等）。</p> <h3 id="实践五-worker-节点与-neck-节点"><a href="#实践五-worker-节点与-neck-节点" class="header-anchor">#</a> 实践五：Worker 节点与 Neck 节点</h3> <p>worker 节点和 neck 节点来自项目实践，并非 Cellink 定义的特殊节点。本小节介绍如何借助这两种节点来实现检测任务。</p> <ul><li><strong>worker 节点</strong>：worker 节点都是叶子节点，名称以 'worker-' 开头。worker 节点通常是产生检测结果的节点，比如异常检测模块。worker 节点的检测结果通常在某 ROI 区域的局部坐标系。因此对外输出前，需要把局部坐标反向传播到根节点的全局坐标系上（见 backward 方法和 retr 方法）</li> <li><strong>neck 节点</strong>：作为数据入口的根节点可以不直接面向各业务节点，而是通过一个 neck 节点代理数据分发。这样做的好处是方便 neck 节点在 backward 方法中收集反向传播回来的检测结果</li></ul> <p>下面代码展示了如何优雅地运行所有 worker 节点并收集它们的检测结果：</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">class</span> <span class="token class-name">InputNode</span><span class="token punctuation">(</span>NodeSI<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    
<span class="token decorator annotation punctuation">@hook_parent</span><span class="token punctuation">(</span>InputNode<span class="token punctuation">)</span>
<span class="token keyword">class</span> <span class="token class-name">Neck</span><span class="token punctuation">(</span>NodeSI<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">def</span> <span class="token function">backward</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> <span class="token builtin">hasattr</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>parent<span class="token punctuation">,</span> <span class="token string">'results'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>parent<span class="token punctuation">.</span>results <span class="token operator">=</span> self<span class="token punctuation">.</span>results
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token comment"># 累积从不同 worker 节点反向传播回来的检测结果</span>
            self<span class="token punctuation">.</span>parent<span class="token punctuation">.</span>results<span class="token punctuation">.</span>extend<span class="token punctuation">(</span>self<span class="token punctuation">.</span>results<span class="token punctuation">)</span>

<span class="token comment"># 运行所有 worker 节点，通过反向传播把检测结果累积到根节点</span>
<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    root <span class="token operator">=</span> InputNode<span class="token punctuation">.</span>load_data<span class="token punctuation">(</span>data<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">_execute</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> <span class="token builtin">str</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">.</span>startswith<span class="token punctuation">(</span><span class="token string">'worker-'</span><span class="token punctuation">)</span> <span class="token keyword">and</span> node<span class="token punctuation">.</span>seek<span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            node<span class="token punctuation">.</span>retr<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment"># 运行每一个 worker 节点并反向传播检测结果给根节点</span>
    root<span class="token punctuation">.</span>traverse<span class="token punctuation">(</span>_execute<span class="token punctuation">)</span>
    results <span class="token operator">=</span> root<span class="token punctuation">.</span>results
</code></pre></div><h3 id="实践六-在节点中使用-cellink"><a href="#实践六-在节点中使用-cellink" class="header-anchor">#</a> 实践六：在节点中使用 Cellink</h3> <p>如果某个节点的业务很复杂，我们建议把它拆解成多个节点。但有时候这种拆解过于冗杂且与主业务无关（更不适合出现在流程视图上），我们就用子模块来封装该节点的业务。节点的子模块可以被另一个 Cellink 驱动，不同层级的 Cellink 不会相互干扰。</p></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/zywvvd/cellink-docs/edit/source/docs/practice/README.md" target="_blank" rel="noopener noreferrer">帮助我们完善文档</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="last-updated"><span class="prefix">文档更新于:</span> <span class="time">2022年9月20日 23:17</span></div></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/cellink-docs/assets/js/app.3da618ae.js" defer></script><script src="/cellink-docs/assets/js/2.79f3453a.js" defer></script><script src="/cellink-docs/assets/js/10.f15f1fa1.js" defer></script>
  </body>
</html>
